# Custom Stats Collector Plan

**Status**: Planning
**Created**: 2025-12-09
**Goal**: Replace PostHog with a custom SonicJS-based stats collector for install tracking

---

## Overview

Create a self-hosted statistics collection system using SonicJS itself to track anonymous telemetry data. This replaces the existing PostHog integration with a lightweight, custom solution that gives us full control over our data.

### Phase 1 Scope (This Plan)

- Track **local installs only** (via `npx create-sonicjs`)
- Each install has a unique anonymous ID
- Store events in a D1 database
- Manual deployment to Cloudflare

### Why Replace PostHog?

1. **Full data ownership** - No third-party dependencies for core metrics
2. **Eat our own dog food** - Demonstrate SonicJS capabilities
3. **Cost control** - No risk of exceeding free tier limits
4. **Flexibility** - Custom event schema and reporting
5. **Simplicity** - Fewer external dependencies

---

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│              create-sonicjs CLI                          │
│   (packages/create-app/src/telemetry.js)                │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ HTTP POST (JSON)
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│              Stats Collector API                         │
│   (packages/stats/ - SonicJS app on Cloudflare Workers) │
│                                                          │
│   Endpoints:                                             │
│   POST /api/v1/events - Track events                    │
│   GET  /api/v1/health - Health check                    │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ D1 Database
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│              Cloudflare D1                               │
│                                                          │
│   Tables:                                                │
│   - events (main event storage)                         │
│   - installs (installation tracking)                    │
└─────────────────────────────────────────────────────────┘
```

---

## Database Schema

### Table: `installs`

Tracks unique installations with their anonymous IDs.

| Column | Type | Description |
|--------|------|-------------|
| id | TEXT | Primary key (UUID) |
| installation_id | TEXT | Anonymous installation UUID |
| first_seen | TEXT | ISO timestamp of first event |
| last_seen | TEXT | ISO timestamp of last event |
| os | TEXT | Operating system (darwin, linux, win32) |
| node_version | TEXT | Node.js version (e.g., "v20.10") |
| package_manager | TEXT | npm, yarn, pnpm, bun |
| created_at | TEXT | Record creation timestamp |

### Table: `events`

Stores all telemetry events.

| Column | Type | Description |
|--------|------|-------------|
| id | TEXT | Primary key (UUID) |
| installation_id | TEXT | Foreign key to installs |
| event_type | TEXT | Event name (installation_started, etc.) |
| properties | TEXT | JSON string of event properties |
| timestamp | TEXT | ISO timestamp of event |
| created_at | TEXT | Record creation timestamp |

### Indexes

- `idx_events_installation_id` - For querying events by install
- `idx_events_event_type` - For filtering by event type
- `idx_events_timestamp` - For time-based queries
- `idx_installs_installation_id` - For unique install lookup

---

## Event Types (Phase 1)

### Installation Events

1. **`installation_started`**
   - Fired when `npx create-sonicjs` begins
   - Properties:
     - `os`: Platform (darwin, linux, win32)
     - `nodeVersion`: Node.js version
     - `packageManager`: npm, yarn, pnpm, bun

2. **`installation_completed`**
   - Fired when installation finishes successfully
   - Properties:
     - `durationMs`: Time taken in milliseconds
     - `template`: Template used (starter, etc.)

3. **`installation_failed`**
   - Fired when installation fails
   - Properties:
     - `errorType`: Sanitized error type
     - `stage`: Where failure occurred (download, setup, dependencies, database)

---

## API Specification

SonicJS automatically generates REST API routes for collections. No custom routes needed.

### POST /v1/events

Track a telemetry event (auto-generated by SonicJS).

**Request:**
```json
{
  "data": {
    "installation_id": "uuid-v4",
    "event_type": "installation_started",
    "properties": {
      "os": "darwin",
      "nodeVersion": "v20.10",
      "packageManager": "npm"
    },
    "timestamp": "2025-12-09T10:00:00.000Z"
  }
}
```

**Response (201):**
```json
{
  "data": {
    "id": "uuid-v4",
    "installation_id": "uuid-v4",
    "event_type": "installation_started",
    ...
  }
}
```

### POST /v1/installs

Create/update install record (auto-generated by SonicJS).

**Request:**
```json
{
  "data": {
    "installation_id": "uuid-v4",
    "os": "darwin",
    "node_version": "v20.10",
    "package_manager": "npm",
    "first_seen": "2025-12-09T10:00:00.000Z",
    "last_seen": "2025-12-09T10:00:00.000Z"
  }
}
```

---

## Implementation Steps

### Step 1: Create Stats App

1. Create `/packages/stats` directory in project root
2. Run `npm create-sonicjs stats` to scaffold the app
3. Configure for Cloudflare Workers deployment

### Step 2: Define Collections (Config-Based)

Define collections in `packages/stats/src/db/schema.ts` or via admin UI. SonicJS auto-generates API routes.

**installs collection config:**
```typescript
export const installs = {
  tableName: "installs",
  access: {
    operation: "create", // Allow anonymous create for telemetry
    access: true
  },
  fields: {
    installation_id: {
      type: "text",
      required: true,
      unique: true
    },
    first_seen: {
      type: "text"
    },
    last_seen: {
      type: "text"
    },
    os: {
      type: "text"
    },
    node_version: {
      type: "text"
    },
    package_manager: {
      type: "text"
    }
  }
}
```

**events collection config:**
```typescript
export const events = {
  tableName: "events",
  access: {
    operation: "create",
    access: true
  },
  fields: {
    installation_id: {
      type: "text",
      required: true
    },
    event_type: {
      type: "text",
      required: true
    },
    properties: {
      type: "json"
    },
    timestamp: {
      type: "text"
    }
  }
}
```

### Step 3: Configure Access Control

Set up access control so:
- **Create**: Public (anonymous telemetry)
- **Read/Update/Delete**: Admin only (protected)

This is handled in the collection config via the `access` property.

### Step 4: Update create-sonicjs Telemetry

Modify `packages/create-app/src/telemetry.js` to use standard SonicJS API:

```javascript
// Change from PostHog to custom SonicJS endpoint
const TELEMETRY_ENDPOINT = process.env.SONICJS_TELEMETRY_ENDPOINT || 'https://stats.sonicjs.com'

async function track(event, properties = {}) {
  if (!TELEMETRY_ENABLED) return

  try {
    if (!installationId) {
      installationId = getInstallationId()
    }

    const timestamp = new Date().toISOString()

    // Use standard SonicJS collection API
    const payload = {
      data: {
        installation_id: installationId,
        event_type: event,
        properties: {
          ...properties,
          os: os.platform(),
          nodeVersion: process.version.split('.').slice(0, 2).join('.'),
        },
        timestamp
      }
    }

    // Fire and forget - don't block on response
    fetch(`${TELEMETRY_ENDPOINT}/v1/events`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch(() => {}) // Silent fail

    if (DEBUG) {
      console.log('[Telemetry] Tracked:', event, payload)
    }
  } catch (error) {
    // Silent fail
    if (DEBUG) {
      console.error('[Telemetry] Failed to track event:', error)
    }
  }
}
```

### Step 5: Deploy Stats App

1. Create D1 database: `wrangler d1 create sonicjs-stats`
2. Update `wrangler.toml` with D1 binding
3. Run migrations: `wrangler d1 migrations apply sonicjs-stats`
4. Deploy: `wrangler deploy`

---

## Migration Plan

### Remove PostHog

1. Remove `posthog-node` dependency from:
   - `packages/create-app/package.json`
   - `packages/core/package.json`

2. Update telemetry code to use custom endpoint

3. Keep existing opt-out mechanisms:
   - `SONICJS_TELEMETRY=false`
   - `DO_NOT_TRACK=1`

### Data Migration

- No migration needed - start fresh with new system
- Historical PostHog data remains accessible if needed

---

## Security Considerations

### Rate Limiting

- Implement basic rate limiting on `/api/v1/events`
- Limit to 10 requests per minute per IP
- Use Cloudflare's built-in rate limiting

### Input Validation

- Validate all incoming data
- Sanitize properties to prevent injection
- Reject oversized payloads (max 10KB)

### CORS

- Allow requests from any origin (CLI needs this)
- Only accept POST for `/api/v1/events`

---

## Monitoring & Reporting

### Basic Metrics (Future)

Create a simple admin dashboard showing:

- Total installations (all time)
- Installations per day/week/month
- OS distribution
- Node version distribution
- Package manager usage
- Success vs failure rates

### Queries

```sql
-- Total installations
SELECT COUNT(DISTINCT installation_id) FROM installs;

-- Installations per day
SELECT DATE(first_seen) as day, COUNT(*)
FROM installs
GROUP BY day
ORDER BY day DESC;

-- OS distribution
SELECT os, COUNT(*)
FROM installs
GROUP BY os;

-- Success rate
SELECT
  event_type,
  COUNT(*) as count,
  COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM events
WHERE event_type IN ('installation_completed', 'installation_failed')
GROUP BY event_type;
```

---

## File Structure

```
packages/stats/
├── src/
│   ├── index.ts              # Main entry point (standard SonicJS)
│   └── db/
│       └── schema.ts         # Collection definitions (installs, events)
├── drizzle/
│   └── migrations/           # Database migrations (auto-generated)
├── wrangler.toml             # Cloudflare configuration
├── package.json
└── tsconfig.json
```

No custom routes needed - SonicJS auto-generates `/v1/installs` and `/v1/events` endpoints from schema.

---

## Testing Strategy

### Unit Tests

- Event validation logic
- Property sanitization
- Rate limiting

### Integration Tests

- End-to-end event tracking
- Database operations
- API response formats

### Manual Testing

1. Run `npx create-sonicjs test-app`
2. Verify events appear in D1 database
3. Test opt-out with `SONICJS_TELEMETRY=false`

---

## Timeline

### Phase 1: Local Install Tracking

1. **Create stats app** - Set up SonicJS app in `/packages/stats`
2. **Define schema** - Create collections and migrations
3. **Build API** - Implement event tracking endpoint
4. **Deploy** - Manual deploy to Cloudflare
5. **Integrate** - Update create-sonicjs to use new endpoint
6. **Test** - Verify end-to-end flow
7. **Remove PostHog** - Clean up old dependencies

### Future Phases

- **Phase 2**: Runtime telemetry (dev server events)
- **Phase 3**: Admin UI analytics
- **Phase 4**: Reporting dashboard

---

## Open Questions

1. **Domain**: Should stats app be at `stats.sonicjs.com` or a subdomain?
2. **Retention**: How long to keep event data? (Suggest 1 year)
3. **Backups**: Set up D1 backup strategy?
4. **Access**: Who should have access to the stats data?

---

## Approval Checklist

- [ ] Architecture reviewed
- [ ] Schema approved
- [ ] API design approved
- [ ] Security considerations reviewed
- [ ] Ready to begin implementation

---

**Last Updated**: 2025-12-09
