export const metadata = {
  title: 'Authentication - SonicJS',
  description:
    'Secure your SonicJS application with JWT authentication, role-based access control, and user management.',
}

export const sections = [
  { title: 'Overview', id: 'overview' },
  { title: 'JWT Authentication', id: 'jwt-authentication' },
  { title: 'Passwordless Authentication', id: 'passwordless-authentication' },
  { title: 'User Management', id: 'user-management' },
  { title: 'RBAC', id: 'rbac' },
]

# Authentication

Secure your SonicJS application with JWT authentication and role-based access control. {{ className: 'lead' }}

## Overview

SonicJS uses JWT (JSON Web Tokens) for authentication with:

- **24-hour token expiration**
- **HTTP-only cookie storage** for web clients
- **Bearer token support** for API clients
- **KV-based token caching** (5-minute TTL)
- **Role-based access control** (RBAC)
- **Permission system** for fine-grained access

<FeatureGrid
  features={[
    {
      icon: 'üîê',
      title: 'JWT Tokens',
      description: 'Secure, stateless authentication with automatic expiration',
    },
    {
      icon: 'üë•',
      title: 'User Roles',
      description: 'Admin, Editor, Author, and Viewer roles with different permissions',
    },
    {
      icon: '‚ö°',
      title: 'Fast Verification',
      description: 'KV cache for sub-millisecond token verification',
    },
    {
      icon: 'üîí',
      title: 'Secure by Default',
      description: 'HTTP-only cookies, CSRF protection, and rate limiting',
    },
  ]}
  columns={2}
/>

---

## JWT Authentication

### Login

<ApiEndpoint method="POST" path="/auth/login" description="Authenticate user and receive JWT token" auth={false} />

<CodeGroup title="Login Request">

```bash {{title:'cURL'}}
curl -X POST http://localhost:8787/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@sonicjs.com",
    "password": "sonicjs!"
  }'
```

```javascript
const response = await fetch('http://localhost:8787/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'admin@sonicjs.com',
    password: 'sonicjs!'
  })
});

const { user, token } = await response.json();
```

</CodeGroup>

**Response (200 OK):**

```json
{
  "user": {
    "id": "admin-user-id",
    "email": "admin@sonicjs.com",
    "username": "admin",
    "firstName": "Admin",
    "lastName": "User",
    "role": "admin"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Using the Token

Include the token in the Authorization header for authenticated requests:

<CodeGroup title="Authenticated Request">

```bash {{title:'cURL'}}
curl http://localhost:8787/admin/content \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

```javascript
const response = await fetch('http://localhost:8787/admin/content', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

</CodeGroup>

For browser-based applications, the token is automatically stored as an HTTP-only cookie named `auth_token`.

---

## Passwordless Authentication

SonicJS offers multiple passwordless authentication methods through plugins. These plugins are **inactive by default** and need to be enabled in the admin panel.

### OTP Login Plugin

The **OTP (One-Time Password) Login Plugin** provides email-based authentication with temporary codes.

**Features:**
- Configurable OTP code length (4-8 digits)
- Code expiration (5-60 minutes, default: 10 minutes)
- Rate limiting (default: 5 codes per hour)
- Max verification attempts (default: 3)
- Optional new user registration support

**Installation:**

1. Navigate to **Admin** ‚Üí **Plugins**
2. Find **OTP Login** plugin
3. Click **Activate**
4. Configure settings:
   - **Code Length**: 4-8 digits (default: 6)
   - **Code Expiration**: 5-60 minutes (default: 10)
   - **Max Attempts**: 3-10 (default: 3)
   - **Rate Limit**: Codes per hour (default: 5)
   - **Allow Registration**: Enable if you want new users to register via OTP

**API Usage:**

<CodeGroup title="OTP Login Flow">

```bash {{title:'Request OTP Code'}}
# Step 1: Request OTP code
curl -X POST http://localhost:8787/auth/otp/request \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com"
  }'

# Response: { "message": "OTP code sent to email" }
```

```bash {{title:'Verify OTP Code'}}
# Step 2: Verify OTP code
curl -X POST http://localhost:8787/auth/otp/verify \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "code": "123456"
  }'

# Response: { "user": {...}, "token": "eyJhbGc..." }
```

</CodeGroup>

**Database Schema:**

The OTP plugin creates a new table `otp_codes`:

```sql
CREATE TABLE otp_codes (
  id TEXT PRIMARY KEY,
  user_email TEXT NOT NULL,
  code TEXT NOT NULL,
  expires_at INTEGER NOT NULL,
  attempts INTEGER DEFAULT 0,
  created_at INTEGER DEFAULT (unixepoch())
);
```

### Magic Link Authentication Plugin

The **Magic Link Plugin** enables passwordless login via email links.

**Features:**
- One-click email authentication
- No password required
- Secure token-based links
- Optional user registration

**Installation:**

1. Navigate to **Admin** ‚Üí **Plugins**
2. Find **Magic Link Auth** plugin
3. Click **Activate**
4. Configure email settings (requires Email Plugin)

**API Usage:**

<CodeGroup title="Magic Link Flow">

```bash {{title:'Request Magic Link'}}
# Step 1: Request magic link
curl -X POST http://localhost:8787/auth/magic-link/request \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com"
  }'

# Response: { "message": "Magic link sent to email" }
```

```bash {{title:'Verify Magic Link'}}
# Step 2: User clicks link in email
# GET /auth/magic-link/verify?token=abc123...

# Automatically redirects to admin with auth cookie set
```

</CodeGroup>

### Choosing an Authentication Method

| Method | Best For | Security | User Experience |
|--------|----------|----------|-----------------|
| **Email + Password** | Traditional apps, maximum control | ‚≠ê‚≠ê‚≠ê‚≠ê | Familiar, requires password management |
| **OTP Login** | Mobile apps, high-security environments | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Easy, no password needed, limited time |
| **Magic Link** | Simplified onboarding, newsletters | ‚≠ê‚≠ê‚≠ê‚≠ê | Seamless, requires email access |

<Callout type="info">
**Email Plugin Required:** Both OTP and Magic Link authentication require the Email Plugin to be configured with a valid email service (e.g., Resend, SendGrid).
</Callout>

---

## User Management

### User Registration

<ApiEndpoint method="POST" path="/auth/register" description="Create new user account" auth={false} />

<CodeGroup title="Register User">

```bash {{title:'cURL'}}
curl -X POST http://localhost:8787/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securepassword123",
    "username": "newuser",
    "firstName": "John",
    "lastName": "Doe"
  }'
```

```javascript
const response = await fetch('http://localhost:8787/auth/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'securepassword123',
    username: 'newuser',
    firstName: 'John',
    lastName: 'Doe'
  })
});

const { user, token } = await response.json();
```

</CodeGroup>

---

## RBAC

### User Roles

SonicJS supports four built-in roles:

<Properties>
  <Property name="admin" type="string">
    Full system access. Can manage users, content, settings, and plugins.
  </Property>
  <Property name="editor" type="string">
    Content management. Can create, edit, publish, and delete content.
  </Property>
  <Property name="author" type="string">
    Content creation. Can create and edit own content, but not publish.
  </Property>
  <Property name="viewer" type="string">
    Read-only access. Can view content but not modify.
  </Property>
</Properties>

### Middleware

Protect routes with authentication and role-based middleware:

<CodeGroup title="Middleware Protection">

```typescript
// Require authentication
app.use('/admin/*', requireAuth())

// Require specific role
app.use('/admin/*', requireRole(['admin', 'editor']))

// Require permission
app.use('/admin/settings/*', requirePermission('manage:settings'))

// Optional authentication
app.use('/api/*', optionalAuth())
```

</CodeGroup>

---

## Next Steps

<div className="not-prose">
  <Button href="/api" variant="text" arrow="right">
    <>Explore the full API reference</>
  </Button>
</div>

<div className="not-prose mt-4">
  <Button href="/deployment" variant="text" arrow="right">
    <>Deploy to production</>
  </Button>
</div>
